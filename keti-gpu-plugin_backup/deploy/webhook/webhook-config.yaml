apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: keti-gpu-webhook
  labels:
    app: keti-gpu-webhook
webhooks:
  - name: gpu-injector.keti.io
    clientConfig:
      service:
        name: keti-gpu-webhook
        namespace: edge-system
        path: /mutate
      # CA Bundle will be injected by cert-manager or manually
      # caBundle: <BASE64_ENCODED_CA_CERT>
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    # Only mutate pods with GPU annotations or resources
    objectSelector:
      matchExpressions:
        - key: "app"
          operator: "NotIn"
          values: ["keti-gpu-webhook", "keti-gpu-plugin"]
    namespaceSelector:
      matchExpressions:
        # Exclude system namespaces
        - key: "kubernetes.io/metadata.name"
          operator: "NotIn"
          values: ["kube-system", "edge-system"]
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    failurePolicy: Ignore  # Don't block pod creation if webhook fails
    timeoutSeconds: 10
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keti-gpu-webhook
  namespace: edge-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: keti-gpu-webhook
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["mutatingwebhookconfigurations"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: keti-gpu-webhook
subjects:
  - kind: ServiceAccount
    name: keti-gpu-webhook
    namespace: edge-system
roleRef:
  kind: ClusterRole
  name: keti-gpu-webhook
  apiGroup: rbac.authorization.k8s.io
